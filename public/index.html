<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Tenant OTP Bot Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .add-bot-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
            margin: 20px auto;
            display: block;
        }

        .add-bot-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .bots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .bot-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .bot-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
        }

        .bot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .bot-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .status-running {
            background: #d4edda;
            color: #155724;
        }

        .status-stopped {
            background: #f8d7da;
            color: #721c24;
        }

        .bot-info {
            margin: 15px 0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.95rem;
        }

        .info-label {
            color: #666;
            font-weight: 500;
        }

        .info-value {
            color: #333;
            font-weight: 600;
        }

        .channels-list {
            margin: 10px 0;
        }

        .channel-tag {
            display: inline-block;
            background: #e9ecef;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            margin: 3px;
            color: #495057;
        }

        .bot-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .btn-start {
            background: #28a745;
            color: white;
        }

        .btn-start:hover {
            background: #218838;
        }

        .btn-stop {
            background: #dc3545;
            color: white;
        }

        .btn-stop:hover {
            background: #c82333;
        }

        .btn-logs {
            background: #17a2b8;
            color: white;
        }

        .btn-logs:hover {
            background: #138496;
        }

        .btn-delete {
            background: #6c757d;
            color: white;
        }

        .btn-delete:hover {
            background: #5a6268;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.8rem;
            color: #333;
        }

        .close-btn {
            font-size: 2rem;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .channel-inputs {
            margin-top: 10px;
        }

        .channel-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .add-channel-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .remove-channel-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-primary {
            flex: 1;
            background: #667eea;
            color: white;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            flex: 1;
            background: #6c757d;
            color: white;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            color: white;
            padding: 60px 20px;
        }

        .empty-state h2 {
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .empty-state p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 40px;
        }

        .logs-content {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            border-left: 3px solid #667eea;
            background: white;
            border-radius: 4px;
        }

        .log-error {
            border-left-color: #dc3545;
        }

        .log-warning {
            border-left-color: #ffc107;
        }

        @media (max-width: 768px) {
            .bots-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .modal-content {
                margin: 20px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Multi-Tenant OTP Bot Manager</h1>
            <p>Manage multiple OTP bots for different users</p>
            <button class="add-bot-btn" onclick="openAddBotModal()">‚ûï Add OTP Bot</button>
        </div>

        <div id="botsContainer">
            <div class="loading">Loading bots...</div>
        </div>
    </div>

    <!-- Add Bot Modal -->
    <div id="addBotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New OTP Bot</h2>
                <button class="close-btn" onclick="closeAddBotModal()">&times;</button>
            </div>

            <form id="addBotForm">
                <div class="form-group">
                    <label class="form-label">User Name *</label>
                    <input type="text" class="form-input" id="userName" required placeholder="e.g., John Doe">
                </div>

                <div class="form-group">
                    <label class="form-label">Panel Username *</label>
                    <input type="text" class="form-input" id="panelUsername" required placeholder="Panel login username">
                </div>

                <div class="form-group">
                    <label class="form-label">Panel Password *</label>
                    <input type="password" class="form-input" id="panelPassword" required placeholder="Panel login password">
                </div>

                <div class="form-group">
                    <label class="form-label">Login URL (Optional)</label>
                    <input type="text" class="form-input" id="loginUrl" placeholder="Default: http://139.99.63.204/ints/login">
                </div>

                <div class="form-group">
                    <label class="form-label">SMS Reports URL (Optional)</label>
                    <input type="text" class="form-input" id="smsReportsUrl" placeholder="Default: http://139.99.63.204/ints/agent/SMSCDRReports">
                </div>

                <div class="form-group">
                    <label class="form-label">Telegram Bot Token *</label>
                    <input type="text" class="form-input" id="botToken" required placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
                </div>

                <div class="form-group">
                    <label class="form-label">Telegram Channel IDs *</label>
                    <div id="channelInputs" class="channel-inputs">
                        <div class="channel-input-group">
                            <input type="text" class="form-input" placeholder="-1001234567890" required>
                            <button type="button" class="remove-channel-btn" onclick="removeChannelInput(this)">‚úï</button>
                        </div>
                    </div>
                    <button type="button" class="add-channel-btn" onclick="addChannelInput()">‚ûï Add Another Channel</button>
                </div>

                <div class="form-group">
                    <label class="form-label">Poll Interval (seconds)</label>
                    <input type="number" class="form-input" id="pollInterval" value="30" min="5" placeholder="30">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">üöÄ Deploy Bot</button>
                    <button type="button" class="btn-secondary" onclick="closeAddBotModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Logs Modal -->
    <div id="logsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Bot Logs</h2>
                <button class="close-btn" onclick="closeLogsModal()">&times;</button>
            </div>
            <div id="logsContent" class="logs-content">
                Loading logs...
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let currentLogsBotId = null;

        // Load bots on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadBots();
            setInterval(loadBots, 10000); // Refresh every 10 seconds
        });

        async function loadBots() {
            try {
                const response = await fetch(`${API_URL}/api/bots`);
                const bots = await response.json();
                
                const container = document.getElementById('botsContainer');
                
                if (bots.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h2>No bots configured yet</h2>
                            <p>Click "Add OTP Bot" to create your first bot</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '<div class="bots-grid">' + bots.map(bot => `
                    <div class="bot-card">
                        <div class="bot-header">
                            <div class="bot-name">üë§ ${bot.user_name}</div>
                            <div class="status-badge ${bot.status === 'running' ? 'status-running' : 'status-stopped'}">
                                ${bot.status === 'running' ? 'üü¢ Running' : 'üî¥ Stopped'}
                            </div>
                        </div>
                        
                        <div class="bot-info">
                            <div class="info-row">
                                <span class="info-label">Panel User:</span>
                                <span class="info-value">${bot.panel_username}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Poll Interval:</span>
                                <span class="info-value">${bot.poll_interval/1000}s</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Channels:</span>
                                <span class="info-value">${bot.telegram_chat_ids.length}</span>
                            </div>
                            <div class="channels-list">
                                ${bot.telegram_chat_ids.map(id => `<span class="channel-tag">${id}</span>`).join('')}
                            </div>
                        </div>

                        <div class="bot-actions">
                            ${bot.status === 'running' 
                                ? `<button class="btn btn-stop" onclick="stopBot('${bot.id}')">‚è∏Ô∏è Stop</button>`
                                : `<button class="btn btn-start" onclick="startBot('${bot.id}')">‚ñ∂Ô∏è Start</button>`
                            }
                            <button class="btn btn-logs" onclick="viewLogs('${bot.id}')">üìã Logs</button>
                            <button class="btn btn-delete" onclick="deleteBot('${bot.id}', '${bot.user_name}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `).join('') + '</div>';
            } catch (error) {
                console.error('Error loading bots:', error);
                document.getElementById('botsContainer').innerHTML = `
                    <div class="empty-state">
                        <h2>Error loading bots</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function openAddBotModal() {
            document.getElementById('addBotModal').style.display = 'block';
        }

        function closeAddBotModal() {
            document.getElementById('addBotModal').style.display = 'none';
            document.getElementById('addBotForm').reset();
        }

        function addChannelInput() {
            const container = document.getElementById('channelInputs');
            const div = document.createElement('div');
            div.className = 'channel-input-group';
            div.innerHTML = `
                <input type="text" class="form-input" placeholder="-1001234567890" required>
                <button type="button" class="remove-channel-btn" onclick="removeChannelInput(this)">‚úï</button>
            `;
            container.appendChild(div);
        }

        function removeChannelInput(btn) {
            const container = document.getElementById('channelInputs');
            if (container.children.length > 1) {
                btn.parentElement.remove();
            } else {
                alert('At least one channel is required');
            }
        }

        document.getElementById('addBotForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const channelInputs = document.querySelectorAll('#channelInputs input');
            const channelIds = Array.from(channelInputs).map(input => input.value.trim()).filter(v => v);
            
            const botData = {
                user_name: document.getElementById('userName').value,
                panel_username: document.getElementById('panelUsername').value,
                panel_password: document.getElementById('panelPassword').value,
                login_url: document.getElementById('loginUrl').value || undefined,
                sms_reports_url: document.getElementById('smsReportsUrl').value || undefined,
                telegram_bot_token: document.getElementById('botToken').value,
                telegram_chat_ids: channelIds,
                poll_interval: parseInt(document.getElementById('pollInterval').value) * 1000
            };

            try {
                const response = await fetch(`${API_URL}/api/bots`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(botData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(`Bot created successfully for ${result.user_name}!\n\nClick "Start" to begin monitoring.`);
                    closeAddBotModal();
                    loadBots();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error creating bot: ${error.message}`);
            }
        });

        async function startBot(botId) {
            if (!confirm('Start this bot?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/bots/${botId}/start`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Bot started successfully!');
                    loadBots();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error starting bot: ${error.message}`);
            }
        }

        async function stopBot(botId) {
            if (!confirm('Stop this bot?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/bots/${botId}/stop`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Bot stopped successfully!');
                    loadBots();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error stopping bot: ${error.message}`);
            }
        }

        async function deleteBot(botId, userName) {
            if (!confirm(`Delete bot for ${userName}?\n\nThis action cannot be undone.`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/bots/${botId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Bot deleted successfully!');
                    loadBots();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error deleting bot: ${error.message}`);
            }
        }

        async function viewLogs(botId) {
            currentLogsBotId = botId;
            document.getElementById('logsModal').style.display = 'block';
            
            try {
                const response = await fetch(`${API_URL}/api/bots/${botId}/logs`);
                const logs = await response.json();
                
                const logsContent = document.getElementById('logsContent');
                
                if (logs.length === 0) {
                    logsContent.innerHTML = '<div class="log-entry">No logs available</div>';
                    return;
                }

                logsContent.innerHTML = logs.map(log => `
                    <div class="log-entry log-${log.log_type}">
                        <strong>[${new Date(log.timestamp).toLocaleString()}]</strong>
                        [${log.log_type.toUpperCase()}]
                        ${log.message}
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('logsContent').innerHTML = `
                    <div class="log-entry log-error">Error loading logs: ${error.message}</div>
                `;
            }
        }

        function closeLogsModal() {
            document.getElementById('logsModal').style.display = 'none';
            currentLogsBotId = null;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
